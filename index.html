<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OTN Downloader Server</title>
  </head>
  <body>
    <h2>识别进度</h2>
    <div id="text-process"></div>
    <h2>识别到全部的数据</h2>
    <div id="text-result"></div>
    <h2>识别到当前的数据</h2>
    <div id="text-current-result"></div>
    <h2>错误</h2>
    <div id="error-text"></div>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/jquery@3.6.0/dist/jquery.min.js"></script>
    <div style="width: 500px" id="reader"></div>
    <script>
      var html5QrcodeScanner = new Html5QrcodeScanner("reader", {
        fps: 10,
        qrbox: 250,
      });

      var request = {};
      function processText(decodedText) {
        $("#text-current-result").text(decodedText);
        let dataArray = decodedText.split(":", 3);
        if (dataArray.length < 3) {
          $("#error-text").text("lees 3");
          return;
        }
        let index = dataArray[0];
        let total = dataArray[1];
        let text = dataArray[2];
        if (request[index]) {
          $("#error-text").text("exists index");
          return;
        }
        request[index] = text;
        $("#error-text").text("set index");
        let lastText = $("#text-result").text();
        $("#text-result").text(lastText + text);
        $("#error-text").text("set text");
        $("#text-process").text(index + " : " + total);
        $("#error-text").text("set process");
      }
      function onScanSuccess(decodedText, decodedResult) {
        console.log(decodedText, decodedResult);
        try {
          processText(decodedText);
        } catch (err) {
          $("#error-text").text(err);
        }
      }
      html5QrcodeScanner.render(onScanSuccess);
    </script>
  </body>
</html>
